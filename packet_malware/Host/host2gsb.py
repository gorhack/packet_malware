import re
from .GoogleSB import GSB


def scan(api_key, hosts):
    print("Scanning {} hosts...".format(len(hosts)))
    scanned_hosts = hosts
    gsb = GSB(api_key)
    addrs = []
    resp = 'URL/IP Analysis:'

    url_re = re.compile('.*\..*$')  # super basic ip regex

    for ip, host in hosts.items():
        if url_re.match(host.hostname):
            addrs.append(host.hostname)
        else:
            addrs.append(ip)

    gsb.analyzeUrls(addrs)
    r = gsb.response.split('\n')
    count = 0
    if len(r) > 0 and r[0] != '':
        for h, check in zip(scanned_hosts.values(), r):
            if check == 'ok':
                pass
            else:
                h.warning_level = 1
                count += 1
                if h.ip == host.hostname:
                    resp += "\n  Malicious URL/IP Found: {}".format(h.hostname)
                else:
                    resp += "\n  Malicious URL/IP Found: {} ({})".format(h.hostname,
                                                                         h.ip)
    print("{} malicious URLs/IPs found".format(count))
    return (resp, scanned_hosts)
