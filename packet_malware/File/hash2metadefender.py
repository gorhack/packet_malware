from .Metadefender import Metadefender

def scan(api_key, hashes):
    print("Checking {} files for malware...".format(len(hashes)))
    md = Metadefender(api_key)

    md.analyzeHashes(list(hashes.keys()))
    r = md.response

    bad_files = []
    resp = 'File analysis:\n'

    count = 0
    if len(r) > 0:
        for hash_resp in r:
            result = hash_resp['scan_result']
            result_hash = hash_resp['hash']

            h = hashes[result_hash]
            if result == 1:
                h.warning_level = 2
                count += 1
                # change all the hashes...
                resp += ("\nInfected File Found: {}".format(h.name) +
                         "\n  Type: {}".format(h.file_type) +
                         "\n  Hash: {}".format(h.md5_sum) +
                         "\n  Source IP/Port: {}:{}".format(h.srcip,
                                                              h.srcport) +
                         "\n  Dest IP/Port: {}:{}".format(h.dstip,
                                                            h.dstport))
            elif result == 2:
                h.warning_level = 1
                count += 1
                resp += ("Suspicious File Found: {}".format(h.name) +
                         "\n  Type: {}".format(h.file_type) +
                         "\n  Hash: {}".format(h.md5_sum) +
                         "\n  Source IP/Port: {}:{}".format(h.srcip,
                                                              h.srcport) +
                         "\n  Dest IP/Port: {}:{}\n".format(h.dstip,
                                                              h.dstport))

            bad_files.append(h)

    print("{} infected files found.".format(count))
    return (resp, bad_files)
